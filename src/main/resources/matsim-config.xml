<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE config SYSTEM "http://www.matsim.org/files/dtd/config_v2.dtd">

<config>

    <module name="global">
        <!-- Oskar 2015-12-09, use 24 threads for replanning. Shortest path algorithm. -->
        <param name="numberOfThreads" value="22"/>
        <param name="coordinateSystem" value="EPSG:3006"/>
    </module>

    <module name="network">
        <param name="inputNetworkFile" value="./sthlm_v3.xml"/>
        <param name="timeVariantNetwork" value="true"/>
    </module>

    <module name="controller">
        <!-- true if at the end of a run, plans, network, config etc should be dumped to a file -->
        <param name="dumpDataAtEnd" value="true"/>
        <!-- Defines which mobility simulation will be used. Currently supported: qsim JDEQSim
        Depending on the chosen mobsim, you'll have to add additional config modules to configure the corresponding mobsim.
        For 'qsim', add a module 'qsim' to the config. -->
        <!--  type of routing (least cost path) algorithm used, may have the values: Dijkstra, FastDijkstra, AStarLandmarks or FastAStarLandmarks &ndash -->
        <param name="routingAlgorithmType" value="SpeedyALT"/>   <!--changed-->
        <param name="mobsim" value="qsim"/>
        <param name="overwriteFiles" value="deleteDirectoryIfExists"/>
        <param name="outputDirectory" value="./output"/>
        <param name="firstIteration" value="1"/>
        <param name="lastIteration" value="50"/> <!-- original value 100 -->
    </module>

    <module name="plans">
        <param name="inputPlansFile" value="./matsim-plans-2040_25b.xml"/>
        <parameterset type="strategySettings">
            <param name="ChangeExpBeta" value="0.1"/>
            <param name="beta" value="1.0"/>
            <param name="changeExpBeta.mu" value="1.0"/>
            <param name="changeExpBeta.lambda" value="1.0"/>
            <param name="immutableModes" value="car:h, bike:h"/>
            <!-- Defines how routes are stored in memory. Currently supported: LinkNetworkRoute, CompressedNetworkRoute. -->
            <param name="networkRouteType" value="LinkNetworkRoute"/>
        </parameterset>
    </module>


    <module name="replanning">
        <param name="maxAgentPlanMemorySize" value="5"/> <!-- 0 means unlimited -->
        <param name="fractionOfIterationsToDisableInnovation"
               value="1"/>    <!-- 0.3 is good --> <!-- fraction of iterations where innovative strategies are switched off. if you set it to 0.8 and run from iteration 400 to iteration 500, innovation is switched off at iteration 480 -->
        <param name="planSelectorForRemoval" value="WorstPlanForRemovalSelectorWithConflicts"/>
        <parameterset type="strategysettings">
            <param name="strategyName" value="ReRoute"/>
            <param name="weight" value="0.50"/>   <!-- 0.2 is good -->
        </parameterset>
        <parameterset type="strategysettings">
            <param name="strategyName" value="SelectExpBeta"/>
            <param name="weight" value="0.80"/>  <!-- it was originally set to 0.75-->
        </parameterset>
        <parameterset type="strategysettings">
            <param name="strategyName" value="TimeAllocationMutator"/>
            <param name="weight" value="0.25"/>
        </parameterset>
        <parameterset type="strategysettings">
            <param name="strategyName" value="ChangeTripMode"/>
            <param name="weight" value="0.5"/>  <!-- 0.3 is good -->
        </parameterset>
    </module>


    <module name="qsim">
        <param name="vehiclesSource"
               value="defaultVehicle"/>   <!-- a medium-sized 4-seater every time a vehicle is needed -->
        <param name="flowCapacityFactor" value="0.1"/>
        <param name="storageCapacityFactor" value="0.18"/> <!-- 0.18 when flowCapacityFactor is 0.1-->
        <param name="startTime" value="00:00:00"/>
        <param name="endTime" value="30:00:00"/>
        <param name="mainMode" value="car"/>
        <param name="simEndtimeInterpretation" value="onlyUseEndtime"/>
        <param name="linkDynamics"
               value="PassingQ"/>  <!-- allows vehicles with higher speed to exit the link sooner  -->
        <!-- Oskar 2015-12-09, use 22 threads for qsim (mobsim). Queuing simulation. -->
        <param name="numberOfThreads" value="22"/>
        <param name="trafficDynamics" value="kinematicWaves"/>  <!-- allows for double queue -->
        <param name="simStarttimeInterpretation" value="onlyUseStarttime"/>
        <param name="insertingWaitingVehiclesBeforeDrivingVehicles" value="false"/>
        <param name="removeStuckVehicles" value="false"/>
        <param name="stuckTime" value="1"/>
        <param name="vehicleBehavior" value="wait"/>
        <param name="snapshotStyle" value="queue"/>
        <param name="snapshotperiod" value="00:00:00"/> <!-- 00:00:00 means NO snapshot writing -->
    </module>


    <module name="counts">
        <!-- Transport modes that will be respected for the counts comparison. 'car' is default, which includes also bussed from the pt simulation module. Use this parameter in combination with 'filterModes' = true! -->
        <param name="analyzedModes" value="car"/>
        <!-- Specifies over how many iterations the link volumes should be averaged that are used for the counts comparison. Use 1 or 0 to only use the link volumes of a single iteration. This values cannot be larger than the value specified for writeCountsInterval -->
        <param name="averageCountsOverIterations" value="5"/>
        <!-- factor by which to re-scale the simulated values.  necessary when simulation runs with something different from 100%.  needs to be adapted manually -->
        <param name="countsScaleFactor" value="0.25"/>   <!-- aligned with population file-->
        <!-- distance to distanceFilterCenterNode to include counting stations. The unit of distance is the Euclidean distance implied by the coordinate system -->
        <param name="distanceFilter" value="null"/>
        <!-- node id for center node of distance filter -->
        <param name="distanceFilterCenterNode" value="null"/>
        <!-- If true, link counts from legs performed on modes not included in the 'analyzedModes' parameter are ignored. -->
        <param name="filterModes" value="true"/>
        <!-- The Coordinates Reference System in which the coordinates are expressed in the input file. At import, the coordinates will be converted to the coordinate system defined in "global", and willbe converted back at export. If not specified, no conversion happens. -->
        <param name="inputCRS" value="null"/>
        <!-- input file name to counts package -->
        <param name="inputCountsFile" value="null"/>
        <!-- possible values: `html', `kml', `txt', `all' -->
        <param name="outputformat" value="xml"/>
        <!-- Specifies how often the counts comparison should be calculated and written. -->
        <param name="writeCountsInterval" value="10"/>
    </module>


    <!-- source: https://github.com/matsim-org/matsim-libs/blob/master/contribs/signals/examples/tutorial/example90TrafficLights/useSignalInput/withLanes/config.xml-->
    <module name="counts">
        <!-- factor by which to re-scale the simulated values.  necessary when simulation runs with something different from 100%.  needs to be adapted manually -->
        <param name="countsScaleFactor" value="0.2"/>
    </module>

    <module name="eventsManager">        <!-- Config name 'parallelEventHandling' is deprecated, please use 'eventsManager' instead. -->
        <!-- Oskar 2015-12-09, use 1 threads for event handling -->
        <param name="numberOfThreads" value="1"/>
    </module>

    <module name="travelTimeCalculator">
        <param name="analyzedModes" value="car"/>
        <param name="calculateLinkToLinkTravelTimes" value="false"/>
        <param name="calculateLinkTravelTimes" value="true"/>
        <param name="filterModes" value="false"/>
        <!-- The lenght (in sec) of the time period that is splited into time bins; an additional time bin is created to aggregate all travel times collected after maxTime -->
        <param name="maxTime" value="108000"/>
        <!-- If true, link travel times are measured and calculated separately for each mode in analyzedModes. Other modes are ignored. If true, filterModes has no effect. -->
        <param name="separateModes" value="true"/>
        <!-- How to deal with congested time bins that have no link entry events. `optimistic' assumes free speed (too optimistic); 'experimental_LastMile' is experimental and probably too pessimistic. -->
        <param name="travelTimeAggregator" value="optimistic"/>
        <!-- The size of the time bin (in sec) into which the link travel times are aggregated for the router -->
        <param name="travelTimeBinSize" value="7200"/>
        <!-- How to deal with link entry times at different positions during the time bin. Currently supported: average, linearinterpolation -->
        <param name="travelTimeGetter" value="average"/>
    </module>

    <!-- This part is from matsim-sweden project -->
    <module name="scoring">                    <!-- Config name 'planCalcScore' is deprecated, please use 'scoring' instead. -->
        <parameterset type="scoringParameters">
            <param name="subpopulation" value="null"/>
            <param name="performing" value="6.0"/>
            <param name="waiting" value="-0.0"/>
            <param name="lateArrival" value="-18.0"/>
            <param name="earlyDeparture" value="-0.0"/>
        </parameterset>
        <parameterset type="activityParams">
            <param name="activityType" value="w"/>
            <param name="typicalDuration" value="09:00:00"/>
            <param name="openingTime" value="05:00:00"/>
            <param name="closingTime" value="23:00:00"/>
        </parameterset>
        <parameterset type="activityParams">
            <param name="activityType" value="h"/>
            <param name="typicalDuration" value="05:30:00"/>
        </parameterset>
        <parameterset type="activityParams">
            <param name="activityType" value="o"/>
            <param name="typicalDuration" value="00:30:00"/>
            <param name="openingTime" value="05:00:00"/>
            <param name="closingTime" value="23:00:00"/>
        </parameterset>
        <parameterset type="activityParams">
            <param name="activityType" value="l"/>
            <param name="typicalDuration" value="02:30:00"/>
            <param name="openingTime" value="05:00:00"/>
            <param name="closingTime" value="23:00:00"/>
        </parameterset>
        <parameterset type="activityParams">
            <param name="activityType" value="s"/>
            <param name="typicalDuration" value="00:30:00"/>
            <param name="openingTime" value="05:00:00"/>
            <param name="closingTime" value="23:00:00"/>
        </parameterset>
        <parameterset type="activityParams">
            <param name="activityType" value="c"/>
            <param name="typicalDuration" value="00:30:00"/>
            <param name="openingTime" value="05:00:00"/>
            <param name="closingTime" value="23:00:00"/>
        </parameterset>
        <!-- TO DO: Update! see Matsim guide pg 48 -->
        <param name="marginalUtilityOfMoney" value="1.0"/>
        <param name="utilityOfLineSwitch" value="0.0"/>
        <parameterset type="modeParams">
            <param name="mode" value="car"/>
            <param name="dailyMonetaryConstant" value="0.0"/>
            <param name="dailyUtilityConstant" value="0.0"/>
            <param name="constant" value="-1.0"/>   <!-- 0.0 -->
            <param name="marginalUtilityOfDistance_util_m" value="0.0"/>
            <param name="marginalUtilityOfTraveling_util_hr" value="-0.10"/>  <!-- -0.100 -->
            <param name="monetaryDistanceRate" value="-0.0002"/>
        </parameterset>
        <parameterset type="modeParams">
            <param name="mode" value="pt"/>
            <param name="dailyMonetaryConstant" value="0.0"/>
            <param name="dailyUtilityConstant" value="-0.0"/>
            <param name="constant" value="-2.0"/>  <!-- originally set to -2.0 -->
            <param name="marginalUtilityOfDistance_util_m" value="-0.01"/>  <!-- default 0. value 0.01 is good -->
            <param name="marginalUtilityOfTraveling_util_hr" value="-0.120"/>   <!-- -0.120 -->
            <param name="monetaryDistanceRate" value="-0.0002"/>
        </parameterset>
        <parameterset type="modeParams">
            <param name="mode" value="walk"/>
            <param name="dailyMonetaryConstant" value="0.0"/>
            <param name="dailyUtilityConstant" value="-0.0"/>   <!-- 0.0 -->
            <param name="constant" value="-2.0"/>
            <param name="marginalUtilityOfDistance_util_m" value="0.0"/>
            <param name="marginalUtilityOfTraveling_util_hr" value="-0.073"/>  <!-- -0.073 -->
            <param name="monetaryDistanceRate" value="-0.0002"/>
        </parameterset>
        <parameterset type="modeParams">
            <param name="mode" value="bike"/>
            <param name="dailyMonetaryConstant" value="0.0"/>
            <param name="dailyUtilityConstant" value="0.0"/>
            <param name="constant" value="-1.0"/>   <!-- -2.0 -->
            <param name="marginalUtilityOfDistance_util_m" value="0.0"/>
            <param name="marginalUtilityOfTraveling_util_hr" value="-0.077"/>  <!-- -0.077 -->
            <param name="monetaryDistanceRate" value="-0.0002"/>
        </parameterset>
        <parameterset type="modeParams">
            <param name="mode" value="drt"/>
            <param name="dailyMonetaryConstant" value="0.0"/>
            <param name="dailyUtilityConstant" value="0.0"/>
            <param name="constant" value="0.0"/>
            <param name="marginalUtilityOfDistance_util_m" value="0.0"/>
            <param name="marginalUtilityOfTraveling_util_hr" value="-0.100"/>
            <param name="monetaryDistanceRate" value="-0.0002"/>
        </parameterset>
        <parameterset type="modeParams">
            <param name="mode" value="drt_walk"/>
            <param name="dailyMonetaryConstant" value="0.0"/>
            <param name="dailyUtilityConstant" value="-0.01"/>   <!-- 0.0 -->
            <param name="constant" value="-2.0"/>
            <param name="marginalUtilityOfDistance_util_m" value="0.0"/>
            <param name="marginalUtilityOfTraveling_util_hr" value="-0.073"/>  <!-- -0.073 -->
            <param name="monetaryDistanceRate" value="-0.0002"/>
        </parameterset>
    </module>


    <module name="routing">  <!-- This section is for teleported modes-->
        <param name="beelineDistanceFactor" value="1.8"/>  <!-- This was good with 1.8-->
        <parameterset type="teleportedModeParameters">
            <param name="mode" value="pt"/>
            <param name="beelineDistanceFactor" value="null"/>
            <!--matsim uses m/s for speed instead of km/hr-->
            <param name="teleportedModeSpeed" value="9.0"/>  <!-- 10 was good -->
            <param name="teleportedModeFreespeedFactor" value="null"/>
        </parameterset>
        <parameterset type="teleportedModeParameters">
            <param name="mode" value="walk"/>
            <!--param name="beelineDistanceFactor" value="1.5"/-->
            <param name="teleportedModeSpeed" value="0.5"/>
            <param name="teleportedModeFreespeedFactor" value="null"/>
        </parameterset>
        <parameterset type="teleportedModeParameters">
            <param name="mode" value="bike"/>
            <!--param name="beelineDistanceFactor" value="1.5"/ -->
            <param name="teleportedModeSpeed" value="2.6"/>  <!-- 10 was good -->
            <param name="teleportedModeFreespeedFactor" value="null"/>
        </parameterset>
    </module>

    <module name="changeMode">
        <param name="modeSwitchBehavior" value="fromSpecifiedModesToSpecifiedModes"/>
        <param name="modes" value="car,pt"/>
    </module>

    <module name="subtourModeChoice">
        <!-- Defines whether car availability must be considered or not. A agent has no car only if it has no license, or never access to a car -->
        <param name="chainBasedModes" value="car, bike"/>
    </module>

    <module name="timeAllocationMutator">
        <!--<param name="mutationRange" value="900.0" /> -->
        <!-- Default:true; Defines whether time mutation changes an activity's duration. -->
        <param name="mutationAffectsDuration" value="true"/> <!--changed-->
    </module>

    <module name="roadpricing">
        <param name="tollLinksFile" value="./cordonToll1.xml"/>
    </module>

    <module name="vehicles">
        <param name="vehiclesFile" value="modes.xml"/>
    </module>


    <module name="multiModeDrt">
        <parameterset type="drt">
            <parameterset type="ExtensiveInsertionSearch"/>
            <!-- If true, the startLink is changed to last link in the current schedule, so the taxi starts the next day at the link where it stopped operating the day before. False by default. -->
            <param name="changeStartLinkToLastLinkInSchedule" value="true"/>
            <!-- Defines the slope of the maxTravelTime estimation function (optimisation constraint), i.e. maxTravelTimeAlpha * estimated_drt_travel_time + maxTravelTimeBeta. Alpha should not be smaller than 1. -->
            <param name="maxTravelTimeAlpha" value="1.5"/>
            <!-- Defines the shift of the maxTravelTime estimation function (optimisation constraint), i.e. maxTravelTimeAlpha * estimated_drt_travel_time + maxTravelTimeBeta. Beta should not be smaller than 0. -->
            <param name="maxTravelTimeBeta" value="1200.0"/>
            <!-- Max wait time for the bus to come (optimisation constraint). -->
            <param name="maxWaitTime" value="1200.0"/>
            <!-- Operational Scheme, either door2door or stopbased. door2door by default -->
            <param name="operationalScheme" value="door2door"/>
            <!-- Bus stop duration. -->
            <param name="stopDuration" value="60.0"/>
            <!-- An XML file specifying the vehicle fleet. The file format according to dvrp_vehicles_v1.dtd -->
            <param name="vehiclesFile" value="drtvehicles.xml"/>
            <!-- Writes out detailed DRT customer stats in each iteration. True by default. -->
            <param name="writeDetailedCustomerStats" value="true"/>
            <parameterset type="zonalSystem">
                <param name="zonesGeneration" value="GridFromNetwork"/>
                <param name="cellSize" value="2000"/>
            </parameterset>
            <parameterset type="rebalancing">
                <parameterset type="minCostFlowRebalancingStrategy">
                    <param name="targetAlpha" value="0.5"/>
                    <param name="targetBeta" value="0.5"/>
                </parameterset>
            </parameterset>
            <parameterset type="drtfare">
                <param name="basefare" value="0.5"/>
                <!-- Daily subscription fee (fee = positive value) -->
                <param name="dailySubscriptionFee" value="0.0"/>
                <!-- drt fare per meter (fee = positive value) -->
                <param name="distanceFare_m" value="0.0002"/>
                <!-- drt fare per hour (fee = positive value) -->
                <param name="timeFare_h" value="3.6"/>
                <!-- Minimum fare per trip (paid instead of the sum of base, time and distance fare if that sum would be lower than the minimum fare, fee = positive value). -->
                <param name="minFarePerTrip" value="2.0"/>
            </parameterset>
        </parameterset>
    </module>

    <module name="dvrp">
        <!-- Mode of which the network will be used for routing vehicles, calculating travel times, etc. (fleet operator's perspective). If null, no mode filtering is done; the standard network (Scenario.getNetwork()) is used -->
        <param name="networkModes" value="car"/>
        <!-- Used for estimation of travel times for VrpOptimizer by means of the exponential moving average. The weighting decrease, alpha, must be in (0,1]. We suggest small values of alpha, e.g. 0.05. The averaging starts from the initial travel time estimates. If not provided, the free-speed TTs is used as the initial estimates For more info see comments in: VrpTravelTimeEstimator, VrpTravelTimeModules, DvrpModule. -->
        <param name="travelTimeEstimationAlpha" value="0.05"/>
    </module>

</config>